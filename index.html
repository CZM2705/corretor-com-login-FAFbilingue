<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Corretor de Relatórios - Colégio Santa Úrsula</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f9fafb;
        }
        .hidden { display: none; }
        .prose-custom { color: #374151; }
        .prose-custom h3 { color: #1F2937; font-weight: 600; }
        .prose-custom ul { list-style-position: inside; }
        .prose-custom li::marker { color: #15803d; }
        .card { transition: transform 0.2s, box-shadow 0.2s; }
        .card:hover { transform: translateY(-5px); box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1); }
    </style>
</head>
<body class="text-gray-800">

    <!-- 1. TELA DE LOGIN -->
    <div id="login-screen" class="min-h-screen flex flex-col items-center justify-center bg-gray-50 p-4">
        <div class="max-w-md w-full text-center bg-white p-8 sm:p-12 rounded-2xl shadow-md">
            <img src="https://www.santaurursula.com.br/images/logo-sta-ursula.png" alt="Logo do Colégio Santa Úrsula" class="mx-auto mb-8 h-20 w-auto">
            <h1 class="text-3xl sm:text-4xl font-bold text-gray-800">Corretor de Relatórios</h1>
            <p class="mt-6 text-gray-500">Por favor, faça login com sua conta institucional para continuar.</p>
            <button id="login-button" class="mt-8 w-full inline-flex justify-center items-center gap-3 bg-white py-3 px-6 border border-gray-300 rounded-xl shadow-sm text-sm font-medium text-gray-700 hover:bg-gray-50 transition-transform transform hover:scale-105">
                <svg class="h-5 w-5" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 488 512"><path fill="currentColor" d="M488 261.8C488 403.3 381.5 504 248 504 110.8 504 0 393.2 0 256S110.8 8 248 8c66.8 0 126 21.2 174 55.8L373.5 119.8C340.6 91.2 297.4 73.8 248 73.8c-102.3 0-185.2 82.9-185.2 182.2s82.9 182.2 185.2 182.2c107.4 0 166.9-77.2 172.9-119.8H248v-66.3h239.1c1.3 12.8 2.2 25.8 2.2 39.3z"></path></svg>
                Entrar com Google
            </button>
            <p id="login-error" class="mt-4 text-red-500 font-medium hidden"></p>
        </div>
    </div>

    <!-- 2. TELA DE SELEÇÃO PRINCIPAL (PROGRAMA) -->
    <div id="main-selection-screen" class="min-h-screen flex flex-col items-center justify-center bg-gray-50 p-4 hidden">
        <header class="absolute top-0 left-0 right-0 bg-white shadow-sm">
            <div class="container mx-auto px-4 py-3 flex justify-between items-center">
                <p class="text-sm text-gray-600">Bem-vindo(a), <span class="user-name-display font-semibold"></span>!</p>
                <button class="logout-button text-sm font-medium text-green-700 hover:text-green-900">Sair</button>
            </div>
        </header>
        <div class="text-center">
            <h2 class="text-3xl font-bold text-gray-800 mb-2">Selecione o Programa</h2>
            <p class="text-lg text-gray-500 mb-10">Escolha o programa para o qual deseja corrigir um relatório.</p>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8 max-w-4xl mx-auto">
                <div id="program-regular" class="card cursor-pointer bg-white p-8 rounded-2xl shadow-md text-center">
                    <i class="fa-solid fa-graduation-cap text-5xl text-green-700 mb-4"></i>
                    <h3 class="text-2xl font-bold text-gray-800">Regular</h3>
                </div>
                <div id="program-international" class="card cursor-pointer bg-white p-8 rounded-2xl shadow-md text-center">
                    <i class="fa-solid fa-earth-americas text-5xl text-green-700 mb-4"></i>
                    <h3 class="text-2xl font-bold text-gray-800">Educação Internacional e Integral Bilíngue</h3>
                </div>
            </div>
        </div>
    </div>

    <!-- 3. TELA DE SELEÇÃO DE SUBGRUPO -->
    <div id="subgroup-selection-screen" class="min-h-screen flex flex-col items-center justify-center bg-gray-50 p-4 hidden">
         <header class="absolute top-0 left-0 right-0 bg-white shadow-sm">
            <div class="container mx-auto px-4 py-3 flex justify-between items-center">
                <button id="back-to-main" class="text-sm font-medium text-green-700 hover:text-green-900 flex items-center gap-2"><i class="fa-solid fa-arrow-left"></i>Voltar</button>
                <p class="text-sm text-gray-600">Bem-vindo(a), <span class="user-name-display font-semibold"></span>!</p>
                <button class="logout-button text-sm font-medium text-green-700 hover:text-green-900">Sair</button>
            </div>
        </header>
        <div class="text-center">
            <h2 class="text-3xl font-bold text-gray-800 mb-2">Selecione o Currículo</h2>
            <p class="text-lg text-gray-500 mb-10">Para qual área é o relatório?</p>
            <div id="subgroup-selection-cards" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
        </div>
    </div>

    <!-- 4. TELA DE SELEÇÃO DE SETOR FINAL -->
    <div id="sector-selection-screen" class="min-h-screen flex flex-col items-center justify-center bg-gray-50 p-4 hidden">
         <header class="absolute top-0 left-0 right-0 bg-white shadow-sm">
            <div class="container mx-auto px-4 py-3 flex justify-between items-center">
                <button id="back-to-previous-from-sector" class="text-sm font-medium text-green-700 hover:text-green-900 flex items-center gap-2"><i class="fa-solid fa-arrow-left"></i>Voltar</button>
                <p class="text-sm text-gray-600">Bem-vindo(a), <span class="user-name-display font-semibold"></span>!</p>
                <button class="logout-button text-sm font-medium text-green-700 hover:text-green-900">Sair</button>
            </div>
        </header>
        <div class="text-center">
            <h2 class="text-3xl font-bold text-gray-800 mb-2">Selecione a Turma</h2>
            <p class="text-lg text-gray-500 mb-10">Para qual turma/matéria é o relatório?</p>
            <div id="sector-selection-cards" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
        </div>
    </div>


    <!-- 5. APLICAÇÃO PRINCIPAL -->
    <div id="app-screen" class="hidden">
        <header class="bg-white shadow-sm">
            <div class="container mx-auto px-4 py-3 flex justify-between items-center">
                 <button id="back-to-sector-selection" class="text-sm font-medium text-green-700 hover:text-green-900 flex items-center gap-2"><i class="fa-solid fa-arrow-left"></i>Trocar Turma</button>
                <p class="text-sm text-gray-600">Bem-vindo(a), <span class="user-name-display font-semibold"></span>!</p>
                <button class="logout-button text-sm font-medium text-green-700 hover:text-green-900">Sair</button>
            </div>
        </header>
        <div class="container mx-auto px-4 py-8 md:py-12">
            <h2 class="text-3xl font-bold text-center text-gray-800 mb-8">Corretor de Relatórios: <span id="sector-title" class="text-green-800"></span></h2>
            <main class="max-w-4xl mx-auto">
                <div class="bg-white p-6 md:p-8 rounded-2xl shadow-lg">
                    <div class="mb-6">
                        <label for="api-key" class="block text-lg font-semibold text-gray-700 mb-2">Sua Chave de API do Gemini:</label>
                        <input type="password" id="api-key" class="w-full p-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-green-500" placeholder="Cole sua chave de API aqui">
                        <p class="text-sm text-gray-500 mt-2">Sua chave é salva no seu navegador. Obtenha em <a href="https://aistudio.google.com/app/apikey" target="_blank" class="text-green-700 hover:underline">aistudio.google.com</a>.</p>
                    </div>
                    <div class="border-t border-gray-200 my-6"></div>
                    <div class="mb-6">
                        <label for="report-text" class="block text-lg font-semibold text-gray-700 mb-2">Relatório do Aluno:</label>
                        <textarea id="report-text" rows="12" class="w-full p-4 border border-gray-300 rounded-xl focus:ring-2 focus:ring-green-500" placeholder="Cole o texto do relatório aqui..."></textarea>
                    </div>
                    <div class="text-center">
                        <button id="analyze-button" class="bg-green-800 text-white font-bold py-3 px-8 rounded-xl hover:bg-green-900 focus:outline-none focus:ring-4 focus:ring-green-300 transition-transform transform hover:scale-105">Analisar Relatório</button>
                    </div>
                </div>
                <div id="results-container" class="mt-10 bg-white p-6 md:p-8 rounded-2xl shadow-lg hidden">
                    <div id="loading-indicator" class="text-center hidden">
                        <div class="flex justify-center items-center"><svg class="animate-spin -ml-1 mr-3 h-8 w-8 text-green-800" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg><span class="text-lg font-medium text-gray-600">Analisando...</span></div>
                    </div>
                    <div id="suggestions" class="prose prose-custom max-w-none"></div>
                </div>
            </main>
        </div>
    </div>
    
    <!-- Módulos do Firebase -->
    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
      import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

      // --- CONFIGURAÇÃO ---
      const firebaseConfig = {
        apiKey: "AIzaSyCHlvNnopglq7Y8glXo8rUYU-Hn1lR7YTk",
        authDomain: "corretor-com-login-fafbilingue.firebaseapp.com",
        projectId: "corretor-com-login-fafbilingue",
        storageBucket: "corretor-com-login-fafbilingue.firebasestorage.app",
        messagingSenderId: "724149401323",
        appId: "1:724149401323:web:fdf14d941e5cc84db2b0ae"
      };
      const SCHOOL_DOMAIN = "ursulinebrazil.com"; // Verifique se este é o domínio correto

      // --- ESTRUTURA DOS SETORES ---
      const programs = {
        regular: {
          title: "Regular",
          sectors: {
            bercario: { title: "Berçário", icon: "fa-baby-carriage" },
            infantil1e2: { title: "Infantil 1 e 2", icon: "fa-shapes" },
            infantil3: { title: "Infantil 3", icon: "fa-puzzle-piece" },
            fundamentalIniciais: { title: "Fundamental Anos Iniciais", icon: "fa-book-open-reader" },
          }
        },
        international: {
          title: "Educação Internacional e Integral Bilíngue",
          subgroups: {
            english: {
              title: "Currículo de inglês",
              icon: "fa-language",
              sectors: {
                bercario3infantil: { title: "Berçário 3 e Infantil regular", icon: "fa-child" },
                anos1e2: { title: "1º e 2º ano", icon: "fa-pencil" },
                anos3a5: { title: "3º a 5º ano - Digital Literacy", icon: "fa-laptop-code" },
              }
            },
            cambridge: {
              title: "Currículo Cambridge International",
              icon: "fa-book-atlas",
              sectors: {
                earlyYears: { title: "Early Years", icon: "fa-seedling" },
                primary: { title: "Primary - 1st to 5th", icon: "fa-school" },
                lowerSecondary: { title: "Lower Secondary - 6th to 9th", icon: "fa-user-graduate" },
              }
            },
            integral: {
              title: "Integral e atividades extras",
              icon: "fa-clock",
              sectors: {
                integralProf: { title: "Integral - professores de sala", icon: "fa-chalkboard-user" },
                robotica: { title: "Robótica", icon: "fa-robot" },
                gastronomia: { title: "Gastronomia", icon: "fa-utensils" },
              }
            }
          }
        }
      };

      // --- LÓGICA DO APLICATIVO ---
      const app = initializeApp(firebaseConfig);
      const auth = getAuth(app);
      const provider = new GoogleAuthProvider();

      let currentProgramId = null;
      let currentSubgroupId = null;
      let currentSectorId = null;

      const screens = {
          login: document.getElementById('login-screen'),
          mainSelection: document.getElementById('main-selection-screen'),
          subgroupSelection: document.getElementById('subgroup-selection-screen'),
          sectorSelection: document.getElementById('sector-selection-screen'),
          app: document.getElementById('app-screen')
      };
      
      function showScreen(screenName) {
        Object.values(screens).forEach(screen => screen.classList.add('hidden'));
        screens[screenName].classList.remove('hidden');
      }

      onAuthStateChanged(auth, (user) => {
        if (user && user.email.split('@')[1] === SCHOOL_DOMAIN) {
            document.querySelectorAll('.user-name-display').forEach(span => {
                span.textContent = user.displayName || user.email;
            });
            const savedApiKey = localStorage.getItem(`geminiApiKey_${user.uid}`);
            if (savedApiKey) document.getElementById('api-key').value = savedApiKey;
            showScreen('mainSelection');
        } else {
            if (user) signOut(auth);
            showScreen('login');
        }
      });
      
      document.getElementById('login-button').addEventListener('click', () => signInWithPopup(auth, provider));
      document.querySelectorAll('.logout-button').forEach(btn => btn.addEventListener('click', () => signOut(auth)));
      
      document.getElementById('back-to-main').addEventListener('click', () => showScreen('mainSelection'));
      
      // Lógica do botão Voltar na tela de seleção de setor
      document.getElementById('back-to-previous-from-sector').addEventListener('click', () => {
          if (currentSubgroupId) {
              showSubgroupSelection(currentProgramId);
          } else {
              showScreen('mainSelection');
          }
      });

      // Lógica do botão Voltar na tela da aplicação
      document.getElementById('back-to-sector-selection').addEventListener('click', () => {
          showSectorSelection(currentProgramId, currentSubgroupId);
      });

      document.getElementById('program-regular').addEventListener('click', () => showSectorSelection('regular'));
      document.getElementById('program-international').addEventListener('click', () => showSubgroupSelection('international'));

      function showSubgroupSelection(programId) {
          currentProgramId = programId;
          const subgroupCards = document.getElementById('subgroup-selection-cards');
          subgroupCards.innerHTML = '';
          const subgroups = programs[programId].subgroups;
          for (const subgroupId in subgroups) {
              const subgroup = subgroups[subgroupId];
              const card = document.createElement('div');
              card.className = 'card cursor-pointer bg-white p-6 rounded-2xl shadow-md text-center flex flex-col items-center justify-center';
              card.innerHTML = `<i class="fa-solid ${subgroup.icon} text-4xl text-green-700 mb-4"></i><h3 class="text-lg font-bold text-gray-800">${subgroup.title}</h3>`;
              card.addEventListener('click', () => showSectorSelection(programId, subgroupId));
              subgroupCards.appendChild(card);
          }
          showScreen('subgroupSelection');
      }

      function showSectorSelection(programId, subgroupId = null) {
          currentProgramId = programId;
          currentSubgroupId = subgroupId;
          const sectorCards = document.getElementById('sector-selection-cards');
          sectorCards.innerHTML = '';
          
          const sectors = subgroupId ? programs[programId].subgroups[subgroupId].sectors : programs[programId].sectors;
          
          for (const sectorId in sectors) {
              const sector = sectors[sectorId];
              const card = document.createElement('div');
              card.className = 'card cursor-pointer bg-white p-6 rounded-2xl shadow-md text-center flex flex-col items-center justify-center';
              card.innerHTML = `<i class="fa-solid ${sector.icon} text-4xl text-green-700 mb-4"></i><h3 class="text-lg font-bold text-gray-800">${sector.title}</h3>`;
              card.addEventListener('click', () => selectFinalSector(sectorId));
              sectorCards.appendChild(card);
          }
          showScreen('sectorSelection');
      }

      function selectFinalSector(sectorId) {
          currentSectorId = sectorId;
          const sectorData = currentSubgroupId 
              ? programs[currentProgramId].subgroups[currentSubgroupId].sectors[sectorId]
              : programs[currentProgramId].sectors[sectorId];
          document.getElementById('sector-title').textContent = sectorData.title;
          showScreen('app');
      }
      
      function getPromptForSector(programId, subgroupId, sectorId, text) {
          const basePrompt = `Você é um assistente pedagógico...`;
          
          let specificPrompt = `Contexto geral...`;
          // Lógica para buscar o prompt correto na estrutura aninhada
          try {
              if (subgroupId) {
                  specificPrompt = programs[programId].subgroups[subgroupId].sectors[sectorId].prompt;
              } else {
                  specificPrompt = programs[programId].sectors[sectorId].prompt;
              }
          } catch (e) {
              console.warn("Prompt não encontrado para a seleção, usando prompt geral.");
          }
          
          // Adicione os prompts na estrutura 'programs'
          // Ex: programs.regular.sectors.bercario.prompt = `Seu prompt aqui`;
          
          return `${basePrompt} ${specificPrompt || 'Contexto geral...'} \n\n --- \n Texto para análise: \n ${text} \n ---`;
      }
      
      document.getElementById('analyze-button').addEventListener('click', async () => {
        const apiKey = document.getElementById('api-key').value.trim();
        const text = document.getElementById('report-text').value.trim();
        if (!apiKey || !text) {
            alert('Por favor, preencha sua chave de API e o texto do relatório.');
            return;
        }
        if (auth.currentUser) {
            localStorage.setItem(`geminiApiKey_${auth.currentUser.uid}`, apiKey);
        }
        const resultsContainer = document.getElementById('results-container');
        const loadingIndicator = document.getElementById('loading-indicator');
        const suggestionsDiv = document.getElementById('suggestions');
        
        resultsContainer.classList.remove('hidden');
        loadingIndicator.classList.remove('hidden');
        suggestionsDiv.innerHTML = '';
        
        const prompt = getPromptForSector(currentProgramId, currentSubgroupId, currentSectorId, text);
        
        try {
            const suggestions = await callGemini(prompt, apiKey);
            suggestionsDiv.innerHTML = basicMarkdownToHtml(suggestions);
        } catch (error) {
            console.error('Error calling Gemini API:', error);
            suggestionsDiv.innerHTML = '<p class="text-red-500">Ocorreu um erro. Verifique se sua chave de API está correta e tente novamente.</p>';
        } finally {
            loadingIndicator.classList.add('hidden');
        }
      });

      async function callGemini(prompt, apiKey) {
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
        const response = await fetch(apiUrl, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ contents: [{ role: "user", parts: [{ text: prompt }] }] })
        });
        if (!response.ok) throw new Error(`API request failed with status ${response.status}`);
        const result = await response.json();
        if (result.candidates && result.candidates.length > 0) return result.candidates[0].content.parts[0].text;
        throw new Error("Resposta inválida da API do Gemini.");
      }
      
      function basicMarkdownToHtml(md) {
        md = md.replace(/^### (.*$)/gim, '<h3 class="text-xl font-semibold mb-2 mt-4">$1</h3>');
        md = md.replace(/^## (.*$)/gim, '<h2 class="text-2xl font-bold mb-3 mt-5">$1</h2>');
        md = md.replace(/^# (.*$)/gim, '<h1 class="text-3xl font-bold mb-4 mt-6">$1</h1>');
        md = md.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
        md = md.replace(/\*(.*?)\*/g, '<em>$1</em>');
        md = md.replace(/^\* (.*$)/gim, '<li class="mb-1 ml-4">$1</li>');
        md = md.replace(/((<li.*<\/li>\s*)+)/g, '<ul>$1</ul>');
        md = md.replace(/\n\n/g, '</p><p class="mb-4">');
        md = '<p class="mb-4">' + md + '</p>';
        md = md.replace(/<p class="mb-4">\s*<\/p>/g, '');
        md = md.replace(/<\/ul><\/p>/g, '</ul>');
        md = md.replace(/<p class="mb-4"><h/g, '<h');
        md = md.replace(/<\/h3><\/p>/g, '</h3>');
        return md;
      }
    </script>
</body>
</html>
